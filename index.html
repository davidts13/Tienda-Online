<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tienda Online</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    .cart-icon {
      position: relative;
    }
    .cart-icon .badge {
      font-size: 0.75rem;
    }
    
  </style>
</head>
<body>

  <!-- ENCABEZADO CON CARRUSEL E ÍCONO -->
  <div class="container my-3">
    <div class="bg-warning border rounded p-3 shadow">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="m-0">Forever Winter's Shop</h2>
        <div class="cart-icon">
          <i class="bi bi-cart3 fs-3"></i>
          <span id="contadorCarrito" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-dark">0</span>
        </div>
      </div>

      <!-- CARRUSEL -->
      <div id="carouselExample" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-inner rounded">
          <div class="carousel-item active">
            <img src="https://contenido.oyedigital.mx/wp-content/uploads/2024/11/TAYLOR-SWIFT.png">
          </div>
          <div class="carousel-item">
            <img src="https://img2.rtve.es/i/?w=1600&i=1607680761741.jpg" alt="Imagen 2">
          </div>
          <div class="carousel-item">
            <img src="https://i.ytimg.com/vi/OUVafz6qe-8/maxresdefault.jpg" class="d-block w-100 img-fluid" alt="Imagen 3">
          </div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
          <span class="carousel-control-prev-icon"></span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
          <span class="carousel-control-next-icon"></span>
        </button>
      </div>
    </div>
  </div>

  <!-- SECCIÓN PRINCIPAL -->
  <div class="container mb-5">
    <div class="row">

      <!-- CATEGORÍAS -->
      <aside class="col-sm-3 mb-4">
         <div id="categorias" class="row g-3">
         
        </div>
      </aside>

      <!-- PRODUCTOS -->
      <section class="col-sm-9">
        <div id="contenedorProductos" class="row g-3">



        </div>
      </section>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="bg-warning text-white text-center py-3">
    Creado por: David Monterroso - 1890-22-6717
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Script para renderizar productos -->
  <script>
  const url = "https://backcvbgtmdesa.azurewebsites.net/api/productos";
  const categoriasUrl = "https://backcvbgtmdesa.azurewebsites.net/api/categorias";

  const contenedor = document.getElementById("contenedorProductos");
  const contenedorCategorias = document.getElementById("categorias");
  const contadorCarrito = document.getElementById("contadorCarrito");

  let carrito = 0;
  let productosCache = [];      // <- guardamos todos los productos
  let codCatSeleccionada = null;

  // -------- utilidades --------
  const params = new URLSearchParams(window.location.search);
  const codCatInicial = params.get("CodCat");

  function getProductoCatId(p) {
    // Soporta varios nombres posibles del campo categoría en tu API de productos
    return p.id_categoria ?? p.IdCategoria ?? p.CategoriaId ?? p.CodCat ?? p.idCat ?? p.id_categoria;
  }

  function sameId(a, b) {
    if (a === undefined || a === null || b === undefined || b === null) return false;
    return String(a) === String(b);
  }

  function pintarTarjeta(producto) {
    const col = document.createElement("div");
    col.className = "col-sm-12 col-md-4 mb-4";

    let precioHTML = "";
    if (producto.EnOferta && producto.PrecioOferta) {
      precioHTML = `
        <span class="text-danger fw-bold">$${parseFloat(producto.PrecioOferta).toFixed(2)}</span>
        <small class="text-muted text-decoration-line-through">$${parseFloat(producto.Precio).toFixed(2)}</small>
      `;
    } else {
      precioHTML = `<span class="fw-bold">$${parseFloat(producto.Precio).toFixed(2)}</span>`;
    }

    col.innerHTML = `
      <div class="card h-100 shadow-sm">
        <img src="${producto.Imagen}" class="card-img-top img-fluid" alt="${producto.Nombre}">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">${producto.Nombre}</h5>
          <p class="card-text">${producto.Descripcion}</p>
          <p>${precioHTML}</p>
          <a href="#" class="btn btn-warning mt-auto agregarCarrito">Agregar al carrito</a>
        </div>
      </div>
    `;

    col.querySelector(".agregarCarrito").addEventListener("click", e => {
      e.preventDefault();
      carrito++;
      contadorCarrito.textContent = carrito;
    });

    return col;
  }

  function renderProductos(lista) {
    contenedor.innerHTML = "";
    if (!lista || lista.length === 0) {
      contenedor.innerHTML = `
        <div class="col-12">
          <div class="alert alert-warning mb-0">No hay productos para esta categoría.</div>
        </div>`;
      return;
    }
    lista.forEach(p => contenedor.appendChild(pintarTarjeta(p)));
  }

  function aplicarFiltroPorCodCat(codCat) {
    codCatSeleccionada = codCat ?? null;
    if (!codCatSeleccionada) {
      renderProductos(productosCache);
      return;
    }
    const filtrados = productosCache.filter(p => sameId(getProductoCatId(p), codCatSeleccionada));
    renderProductos(filtrados);
  }

  function marcarActivaCategoria(codCat) {
    const links = contenedorCategorias.querySelectorAll("a.list-group-item");
    links.forEach(a => a.classList.remove("active"));
    const target = Array.from(links).find(a => sameId(a.dataset.id, codCat));
    if (target) target.classList.add("active");
  }

  // -------- carga de productos --------
  fetch(url)
    .then(res => res.json())
    .then(productos => {
      productosCache = Array.isArray(productos) ? productos : [];
      // Si ya tenemos una categoría seleccionada (por URL), aplícalo; si no, muestra todo
      aplicarFiltroPorCodCat(codCatInicial);
      if (!codCatInicial) renderProductos(productosCache);
    })
    .catch(error => {
      console.error("Error al cargar productos:", error);
      contenedor.innerHTML = `
        <div class="alert alert-warning">
          No se pudieron cargar los productos. Intenta más tarde.
        </div>`;
    });

  // -------- carga dinámica de categorías --------
  fetch(categoriasUrl)
    .then(res => res.json())
    .then(categorias => {
      const lista = document.createElement("div");
      lista.className = "list-group shadow";

      const titulo = document.createElement("h5");
      titulo.className = "list-group-item bg-warning text-white";
      titulo.textContent = "Categorías";
      lista.appendChild(titulo);

      categorias.forEach(cat => {
        const a = document.createElement("a");
        // Enlace relativo al archivo actual (no dominio "quemado")
        a.href = window.location.pathname + "?CodCat=" + cat.id_categoria;
        a.className = "list-group-item";
        a.dataset.id = cat.id_categoria ?? cat.Id ?? cat.id ?? cat.ID ?? "";
        a.textContent = cat.nombre ?? cat.Nombre ?? cat.Categoria ?? cat.descripcion ?? `Categoría ${a.dataset.id}`;
        lista.appendChild(a);
      });

      contenedorCategorias.appendChild(lista);

      // Marcar activa si vino en URL
      if (codCatInicial) marcarActivaCategoria(codCatInicial);

      // Interceptar clic para filtrar en vivo y actualizar URL (sin recargar)
      contenedorCategorias.querySelectorAll("a.list-group-item").forEach(a => {
        a.addEventListener("click", (e) => {
          // Permitimos que el título (h5) no interfiera
          if (!a.dataset.id) return;
          e.preventDefault();
          const codCat = a.dataset.id;

          // Actualiza URL sin recarga
          const nuevaUrl = window.location.pathname + "?CodCat=" + codCat;
          history.pushState({ CodCat: codCat }, "", nuevaUrl);

          marcarActivaCategoria(codCat);
          aplicarFiltroPorCodCat(codCat);
        });
      });

      // Manejo de navegación del historial (atrás/adelante)
      window.addEventListener("popstate", (ev) => {
        const cod = new URLSearchParams(window.location.search).get("CodCat");
        marcarActivaCategoria(cod);
        aplicarFiltroPorCodCat(cod);
      });
    })
    .catch(err => {
      console.error("Error al cargar categorías:", err);
      contenedorCategorias.innerHTML = `
        <div class="alert alert-warning">No se pudieron cargar las categorías.</div>`;
    });
</script>
</body>
</html>